/*!
 * Report Generator
 * v0.0.1
 */
!function(a,b,c,d){"use strict";var e=b.module("reportGenerator",["dataset-types","advanced-search","display-fields","services.config"]),f=d("#results"),g=100,h={wt:"json"},i={columnDefs:[{className:"nowrap right",targets:[0]}],pageLength:100,lengthMenu:[[50,100,200,500,-1],[50,100,200,500,"All"]]};e.run(["$http","$rootScope","configuration",function(a,b,e){function j(a){var b=/(.*?)((?: (?:OR|AND) )|$)/g;return 0===a.length?"*":a=a.replace(b,function(a,b,c){return 0===b.length||b.match(/:[\(\[].*?[\)\]]/)||(b="text:(*"+b+"*)"),b+c})}function k(a,b){var c,d,e,f,h;for(d=0;d<a.length;d+=1)for(c=a[d],f=0;f<b.length;f+=1)e=b[f],h=c[e],c[e]=h||"","object"==typeof h&&(c[e]=h.splice(0,g).join(","));return a}function l(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push({data:a[b],title:a[b]});return c}function m(){var a=c.pageUrlParts.params.rows;return b.maxResultsOptions[a]?a:void 0}b.query=c.pageUrlParts.params.q?decodeURI(c.pageUrlParts.params.q):"",b.maxResultsOptions={20:20,50:50,100:100,1e3:"1000 (default)",2e3:2e3},b.maxResults=m()||"1000",b.clearKeywords=function(){b.query=""},b.saveUrl=function(){var a=c.pageUrlParts,d=a.absolute.replace(a.search,"").replace(a.hash,"");b.savedUrl=d+"?fq="+b.dataTypeCtrl.selectedDatasetTypes.join(",")+"&q="+b.query+"&fl="+b.dspFieldCtrl.fields.join(",")+"&rows="+b.maxResults},b.sendQuery=function(){var c=e.solrCore+"/select",g=d.extend(h,{fq:"site_id:"+e.siteID+" AND state:active AND dataset_type:("+b.dataTypeCtrl.selectedDatasetTypes.join(" OR ")+")",q:j(b.query),fl:b.dspFieldCtrl.fields.join(","),rows:parseInt(b.maxResults,10)}),m=a.get;-1===e.solrCore.indexOf(e.ckanInstance)&&(m=a.jsonp,g["json.wrf"]="JSON_CALLBACK"),m(c,{params:g}).then(function(a){b.queryError=!1,b.queryResultsCount=a.data.response.numFound,b.queryResults=a.data.response,b.downloadLink=a.config.url+"?"+d.param(d.extend({},a.config.params,{wt:"csv","csv.mv.separator":"Â·",rows:999999999}));var c=a.data.responseHeader.params.fl.split(","),g=d.extend({},i,{data:k(b.queryResults.docs,c),columns:l(c),fnRowCallback:function(a,b){var c=b.name,f=d(a.firstChild);0===f.find("a").length&&f.append('<a target="_blank" href="'+e.ckanInstance+"/dataset/"+c+'" class="btn btn-default"><span class="glyphicon glyphicon-eye-open"><span class="wb-inv">View '+c+'</span></a><a target="_blank" href="'+e.ckanInstance+"/dataset/edit/"+c+'" class="btn btn-default"><span class="glyphicon glyphicon-pencil"><span class="wb-inv">Edit '+c+"</span></a>")}});f.DataTable().destroy(),f.empty(),f.dataTable(g)},function(a){delete b.queryResults,b.queryError=!0,a&&a.data&&a.data.error&&a.data.error.msg&&(b.queryErrorMessage=a.data.error.msg)})}}])}(window,angular,wb,jQuery),angular.module("checklist-model",[]).directive("checklistModel",["$parse","$compile",function(a,b){function c(a,b,c){if(angular.isArray(a))for(var d=a.length;d--;)if(c(a[d],b))return!0;return!1}function d(a,b,d){return a=angular.isArray(a)?a:[],c(a,b,d)||a.push(b),a}function e(a,b,c){if(angular.isArray(a))for(var d=a.length;d--;)if(c(a[d],b)){a.splice(d,1);break}return a}function f(f,g,h){function i(a,b){f.checked=c(a,m,n)}b(g)(f);var j=a(h.checklistModel),k=j.assign,l=a(h.checklistChange),m=a(h.checklistValue)(f.$parent),n=angular.equals;h.hasOwnProperty("checklistComparator")&&(n=a(h.checklistComparator)(f.$parent)),f.$watch("checked",function(a,b){if(a!==b){var c=j(f.$parent);a===!0?k(f.$parent,d(c,m,n)):k(f.$parent,e(c,m,n)),l&&l(f)}}),angular.isFunction(f.$parent.$watchCollection)?f.$parent.$watchCollection(h.checklistModel,i):f.$parent.$watch(h.checklistModel,i,!0)}return{restrict:"A",priority:1e3,terminal:!0,scope:!0,compile:function(a,b){if("INPUT"!==a[0].tagName||"checkbox"!==b.type)throw'checklist-model should be applied to `input[type="checkbox"]`.';if(!b.checklistValue)throw"You should provide `checklist-value`.";return a.removeAttr("checklist-model"),a.attr("ng-model","checked"),f}}}]),function(a,b){"use strict";var c=b.module("advanced-search",["fields"]);c.controller("AdvancedSearchController",["$rootScope",function(a){this.emptyKey=!1,this.operator="AND",this.keyword="",this.onFieldChange=function(){this.fieldType=a.fieldsCtrl.fieldsDef[this.field].type},this.onEmptyChanged=function(){this.emptyKey&&(this.operator="AND")},this.addField=function(){var b,c=function(){var b,c,d,e=function(a){return a.replace(/:/g,"\\:")},f=this.field+":",g=this.keyword;if(this.emptyKey)return"-"+f+"[* TO *]";if(b=a.fieldsCtrl.fieldsDef[this.field].type,"date"===b){try{c=new Date(this.startDate).toISOString(),d=new Date(this.endDate),d.setDate(1),d.setSeconds(-1),d=d.toISOString()}catch(h){}return f+"["+e(c)+" TO "+e(d)+"]"}return f+"(*"+e(g)+"*)"},d="";this.field&&(this.emptyKey||this.keyword||this.startDate&&this.endDate)&&(b=c.apply(this),a.query&&""!==a.query.trim()&&(d=" "+this.operator+" "),a.query+=d+b,this.keyword="")}}]),c.directive("advancedSearch",function(){return{restrict:"E",templateUrl:"templates/advanced-search.html",controller:"AdvancedSearchController",controllerAs:"advSrchCtrl"}}),String.prototype.trim||!function(){var a=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(a,"")}}()}(window,angular),function(a,b,c){"use strict";var d=b.module("dataset-types",["checklist-model","services.config"]);d.controller("DatasetTypesController",["$http","$rootScope","configuration",function(a,b,d){function e(a){var b=["codeset","geodescriptor","subject","survey"];return a.filter(function(a){return-1===b.indexOf(a)?!0:!1})}function f(){var a=c.pageUrlParts.params.fq,b=[];return a&&(decodeURI(a).split(",").forEach(function(a){-1!==i.datasetTypes.indexOf(a)&&b.push(a)}),b.length>0)?b:null}function g(a){var b=a.data.facet_counts.facet_fields.dataset_type.filter(function(a){return"string"==typeof a?!0:!1});i.datasetTypes=b,i.selectedDatasetTypes=f()||e(b),i.changed()}var h=d.solrCore+"/select?fq=site_id:"+d.siteID+"&q=*:*&rows=0&wt=json&facet=true&facet.field=dataset_type",i=this,j=a.get;this.changed=function(){b.$emit("datasetType.selected",this.selectedDatasetTypes)},-1===d.solrCore.indexOf(d.ckanInstance)&&(h+="&json.wrf=JSON_CALLBACK",j=a.jsonp),j(h).then(g)}]),d.directive("datasetTypes",function(){return{restrict:"E",templateUrl:"templates/dataset-types.html",controller:"DatasetTypesController",controllerAs:"dataTypeCtrl"}})}(window,angular,wb),function(a,b,c){"use strict";var d=b.module("display-fields",["fields"]);d.controller("DisplayFieldsController",["$rootScope","$scope",function(a,b){function d(){var a,b=c.pageUrlParts.params.fl;return b?(a=[].concat(e.mandatoryFields),decodeURI(b).split(",").forEach(function(b){-1===a.indexOf(b)&&a.push(b)}),a):null}var e=this;this.field="",this.mandatoryFields=["name"],this.fields=d()||["name","content_type_codes","subject_codes","title_en","admin_notes_en"],this.getVisible=function(){return 0!==this.fields.length},this.getMandatory=function(a){return-1!==this.mandatoryFields.indexOf(a)},this.addField=function(){this.field&&-1===this.fields.indexOf(this.field)&&(this.fields.push(this.field),this.field="")},this.removeField=function(a){this.fields.splice(this.fields.indexOf(a),1)}}]),d.directive("displayFields",function(){return{restrict:"E",templateUrl:"templates/display-fields.html",controller:"DisplayFieldsController",controllerAs:"dspFieldCtrl"}})}(window,angular,wb),function(a,b){"use strict";var c=b.module("fields",["services.config"]);c.controller("FieldsController",["$http","$q","$rootScope","configuration",function(a,b,c,d){var e=this;c.fieldsCtrl=this,this.datasetTypesFields={},this.fields=[],c.$on("datasetType.selected",function(f,g){var h,i,j,k=d.ckanInstance+"/api/3/action/scheming_dataset_schema_show?callback=JSON_CALLBACK&type=",l=function(a){var b,c,d,f,g=a.data.result,h=g.dataset_type,i=g.dataset_fields,j=i.length,k={},l=g.form_languages||[],m=l.length;for(b=0;j>b;b+=1)if(c=i[b],f={type:c.schema_field_type},"fluent"===c.schema_field_type||c.preset&&-1!==c.preset.indexOf("fluent"))for(d=0;m>d;d+=1)k[c.field_name+"_"+l[d]]=f;else if(k[c.field_name]=f,c.lookup)for(d=0;m>d;d+=1)k[c.field_name+"_desc_"+l[d]]=f;e.datasetTypesFields[h]=k,n(h)},m=function(a){var b=a.config.url.match(/type=([^&]*)/)[1],d=c.dataTypeCtrl.datasetTypes;d.splice(d.indexOf(b),1)},n=function(a){$.extend(p,e.datasetTypesFields[a])},o=[],p={};for(h=0;h<g.length;h+=1)i=g[h],e.datasetTypesFields[i]?n(i):(j=a.jsonp(k+i,{cache:!0}).then(l,m),o.push(j));b.all(o).then(function(){e.fields=Object.keys(p).sort(),e.fieldsDef=p})})}])}(window,angular);
//# sourceMappingURL=app.min.js.map